import{r as o,j as e}from"./react-vendor-CJSarQ9f.js";import{o as j}from"./onboardingAPI-_98fszsx.js";import{ap as B,B as r,I as S,aq as W,ar as L,a9 as A,g,S as v,d as m,f as F,a as z,i as K,P as V,aa as H,k as U,l as $}from"./mui-vendor-CUsFfAzq.js";import"./vendor-Bo3UNITv.js";import"./api-DT-DgYzl.js";import"./utils-vendor-D5lHaTRS.js";function Z(){const[c,f]=o.useState(!1),[x,a]=o.useState([]),[p,k]=o.useState(""),[u,_]=o.useState(null),[I,b]=o.useState(null),[h,d]=o.useState(!1),[E,y]=o.useState(!1),D=o.useRef(null),M=()=>{var t;(t=D.current)==null||t.scrollIntoView({behavior:"smooth"})};o.useEffect(()=>{M()},[x]);const O=()=>{let t=localStorage.getItem("kamafile_user_id");return t||(t=`web_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("kamafile_user_id",t)),t};o.useEffect(()=>{c&&!u&&x.length===0&&C()},[c]),o.useEffect(()=>{const t=()=>{f(!0)};return window.addEventListener("openChatWidget",t),()=>{window.removeEventListener("openChatWidget",t)}},[]);const C=async()=>{d(!0),y(!0);try{const t=O(),s=await j.startOnboarding({channel:"web",user_identifier:t});_(s.session_id),b(s.step||null);const n={id:Date.now().toString(),text:s.message,sender:"bot",timestamp:new Date,quickReplies:s.quick_replies||void 0};a([n])}catch{const s={id:Date.now().toString(),text:"Sorry, I'm having trouble starting. Please try again.",sender:"bot",timestamp:new Date};a([s])}finally{d(!1)}},q=async(t,s)=>{if(!u)return;const n={id:Date.now().toString(),text:s,sender:"user",timestamp:new Date};a(i=>[...i,n]),d(!0);try{const i=await j.processStep({session_id:u,step:I||"",response:t});b(i.step||null),y(!i.completed&&i.status==="onboarding");const l={id:(Date.now()+1).toString(),text:i.message,sender:"bot",timestamp:new Date,quickReplies:i.quick_replies||void 0};a(w=>[...w,l])}catch{const l={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};a(w=>[...w,l])}finally{d(!1)}},R=async()=>{if(!p.trim())return;if(!u){await C();return}const t={id:Date.now().toString(),text:p,sender:"user",timestamp:new Date};a(n=>[...n,t]);const s=p;k(""),d(!0);try{const n=await j.processStep({session_id:u,step:I||"",response:s});b(n.step||null),y(!n.completed&&n.status==="onboarding");const i={id:(Date.now()+1).toString(),text:n.message,sender:"bot",timestamp:new Date,quickReplies:n.quick_replies||void 0};a(l=>[...l,i])}catch{const i={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};a(l=>[...l,i])}finally{d(!1)}},P=t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),R())},T=t=>t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return e.jsxs(e.Fragment,{children:[e.jsx(B,{in:!c,children:e.jsx(r,{sx:{position:"fixed",bottom:24,right:24,zIndex:1400,display:c?"none":"block"},children:e.jsx(S,{onClick:()=>f(!0),sx:{bgcolor:"secondary.main",color:"white",width:64,height:64,boxShadow:"0 4px 12px rgba(0,0,0,0.15)","&:hover":{bgcolor:"secondary.dark",transform:"scale(1.05)"},transition:"all 0.2s"},children:e.jsx(W,{sx:{fontSize:28}})})})}),e.jsx(L,{direction:"up",in:c,mountOnEnter:!0,unmountOnExit:!0,children:e.jsxs(A,{elevation:8,sx:{position:"fixed",bottom:24,right:24,width:{xs:"calc(100vw - 48px)",sm:400},maxWidth:400,height:600,maxHeight:{xs:"calc(100vh - 48px)",sm:600},display:"flex",flexDirection:"column",zIndex:1400,borderRadius:3,overflow:"hidden",boxShadow:"0 8px 24px rgba(0,0,0,0.2)"},children:[e.jsxs(r,{sx:{bgcolor:"primary.main",color:"white",p:2,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(g,{sx:{bgcolor:"secondary.main",width:40,height:40},children:e.jsx(v,{})}),e.jsxs(r,{children:[e.jsx(m,{variant:"subtitle1",sx:{fontWeight:600},children:"Tax Assistant"}),e.jsx(m,{variant:"caption",sx:{opacity:.9,fontSize:"0.75rem"},children:E?"Onboarding...":"Online"})]})]}),e.jsx(S,{onClick:()=>f(!1),size:"small",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:e.jsx(F,{})})]}),e.jsxs(r,{sx:{flex:1,overflowY:"auto",p:2,bgcolor:"background.default",display:"flex",flexDirection:"column",gap:2},children:[x.length===0&&h&&e.jsx(r,{sx:{display:"flex",justifyContent:"center",p:2},children:e.jsx(z,{size:24})}),x.map(t=>e.jsxs(r,{sx:{display:"flex",justifyContent:t.sender==="user"?"flex-end":"flex-start",gap:1},children:[t.sender==="bot"&&e.jsx(g,{sx:{bgcolor:"secondary.main",width:32,height:32,order:0},children:e.jsx(v,{sx:{fontSize:18}})}),e.jsxs(r,{sx:{maxWidth:"75%",display:"flex",flexDirection:"column",gap:.5},children:[e.jsx(r,{sx:{bgcolor:t.sender==="user"?"primary.main":"background.paper",color:t.sender==="user"?"white":"text.primary",p:1.5,borderRadius:2,boxShadow:"0 1px 2px rgba(0,0,0,0.1)",wordWrap:"break-word"},children:e.jsx(m,{variant:"body2",sx:{lineHeight:1.5,whiteSpace:"pre-line"},children:t.text})}),t.sender==="bot"&&t.quickReplies&&t.quickReplies.length>0&&e.jsx(r,{sx:{display:"flex",flexDirection:"column",gap:1,mt:.5},children:t.quickReplies.map(s=>e.jsx(K,{variant:"outlined",size:"small",onClick:()=>q(s.payload,s.title),disabled:h,sx:{textTransform:"none",justifyContent:"flex-start",textAlign:"left",borderColor:"primary.main",color:"primary.main","&:hover":{bgcolor:"primary.light",color:"white",borderColor:"primary.light"}},children:s.title},s.payload))}),e.jsx(m,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.7rem",px:1,alignSelf:t.sender==="user"?"flex-end":"flex-start"},children:T(t.timestamp)})]}),t.sender==="user"&&e.jsx(g,{sx:{bgcolor:"primary.light",width:32,height:32,order:1},children:e.jsx(V,{sx:{fontSize:18,color:"white"}})})]},t.id)),h&&x.length>0&&e.jsxs(r,{sx:{display:"flex",justifyContent:"flex-start",gap:1},children:[e.jsx(g,{sx:{bgcolor:"secondary.main",width:32,height:32},children:e.jsx(v,{sx:{fontSize:18}})}),e.jsx(r,{sx:{bgcolor:"background.paper",p:1.5,borderRadius:2,boxShadow:"0 1px 2px rgba(0,0,0,0.1)"},children:e.jsx(z,{size:16})})]}),e.jsx("div",{ref:D})]}),e.jsx(H,{}),e.jsxs(r,{sx:{p:2,bgcolor:"background.paper",display:"flex",gap:1,alignItems:"flex-end"},children:[e.jsx(U,{fullWidth:!0,multiline:!0,maxRows:4,placeholder:"Type your message...",value:p,onChange:t=>k(t.target.value),onKeyPress:P,variant:"outlined",size:"small",disabled:h,sx:{"& .MuiOutlinedInput-root":{borderRadius:2,bgcolor:"background.default"}}}),e.jsx(S,{onClick:R,disabled:!p.trim()||h,sx:{bgcolor:"secondary.main",color:"white",width:40,height:40,"&:hover":{bgcolor:"secondary.dark"},"&:disabled":{bgcolor:"action.disabledBackground",color:"action.disabled"}},children:e.jsx($,{})})]})]})})]})}export{Z as default};
