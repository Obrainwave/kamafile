import{r as c,j as t,S as M}from"./index-DZsrjbsO.js";import{o as j,U as P,S as z}from"./onboardingAPI-Cfvs7LU7.js";import{b as B}from"./api-sa1Artjr.js";import{B as $}from"./Button-ufLcotte.js";import{c as A}from"./createLucideIcon-DEsvD7qG.js";import{B as v}from"./bot-DCGDaEkK.js";import{X as K}from"./x-lbhXhJ4M.js";import{F as U}from"./file-text-D1jEZKHP.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const F=[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]],J=A("message-circle",F),S={ask:async(u,x)=>(await B.post("/api/rag/ask",{question:u,user_context:x})).data};function ee(){const[u,x]=c.useState(!1),[m,o]=c.useState([]),[g,N]=c.useState(""),[p,E]=c.useState(null),[k,b]=c.useState(null),[h,d]=c.useState(!1),[y,f]=c.useState(!1),D=c.useRef(null),q=()=>{var e;(e=D.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(()=>{q()},[m]);const R=()=>{let e=localStorage.getItem("kamafile_user_id");return e||(e=`web_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("kamafile_user_id",e)),e};c.useEffect(()=>{u&&!p&&m.length===0&&C()},[u]),c.useEffect(()=>{const e=()=>{x(!0)};return window.addEventListener("openChatWidget",e),()=>{window.removeEventListener("openChatWidget",e)}},[]);const C=async()=>{d(!0),f(!0);try{const e=R(),a=await j.startOnboarding({channel:"web",user_identifier:e});E(a.session_id),b(a.step||null);const r={id:Date.now().toString(),text:a.message,sender:"bot",timestamp:new Date,quickReplies:a.quick_replies||void 0};o([r])}catch{const a={id:Date.now().toString(),text:"Sorry, I'm having trouble starting. Please try again.",sender:"bot",timestamp:new Date};o([a])}finally{d(!1)}},T=async(e,a)=>{if(!p)return;const r={id:Date.now().toString(),text:a,sender:"user",timestamp:new Date};if(o(s=>[...s,r]),d(!0),_(a)){f(!1);try{const s=localStorage.getItem("user");let n;if(s)try{n={user_type:JSON.parse(s).user_type}}catch{}const i=await S.ask(a,n),l={id:(Date.now()+1).toString(),text:i.answer,sender:"bot",timestamp:new Date,citations:i.citations};o(w=>[...w,l])}catch{const n={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};o(i=>[...i,n])}finally{d(!1)}return}try{const s=await j.processStep({session_id:p,step:k||"",response:e});b(s.step||null);const n=!s.completed&&s.status==="onboarding";if(f(n),!n){const l={id:(Date.now()+1).toString(),text:s.message||"Great! I'm ready to help with your tax questions. Ask me anything!",sender:"bot",timestamp:new Date};o(w=>[...w,l]);return}const i={id:(Date.now()+1).toString(),text:s.message,sender:"bot",timestamp:new Date,quickReplies:s.quick_replies||void 0};o(l=>[...l,i])}catch{const n={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};o(i=>[...i,n])}finally{d(!1)}},_=e=>{const a=["tax","vat","paye","wht","cgt","cit","petroleum","stamp","duty","customs","firs","federal inland revenue","inland revenue","section","act","law","regulation","compliance","filing","return","assessment","penalty","fine","taxable","exempt","deduction","allowance","relief","taxable income","tax rate"],r=e.toLowerCase();return a.some(s=>r.includes(s))},I=async()=>{if(!g.trim())return;if(!p){await C();return}const e={id:Date.now().toString(),text:g,sender:"user",timestamp:new Date};o(r=>[...r,e]);const a=g;N(""),d(!0);try{if(_(a))try{const r=localStorage.getItem("user");let s;if(r)try{s={user_type:JSON.parse(r).user_type}}catch{}const n=await S.ask(a,s),i={id:(Date.now()+1).toString(),text:n.answer,sender:"bot",timestamp:new Date,citations:n.citations};o(l=>[...l,i]),y&&f(!1)}catch{const s={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};o(n=>[...n,s])}else if(y){const r=await j.processStep({session_id:p,step:k||"",response:a});b(r.step||null),f(!r.completed&&r.status==="onboarding");const s={id:(Date.now()+1).toString(),text:r.message,sender:"bot",timestamp:new Date,quickReplies:r.quick_replies||void 0};o(n=>[...n,s])}else try{const r=localStorage.getItem("user");let s;if(r)try{s={user_type:JSON.parse(r).user_type}}catch{}const n=await S.ask(a,s),i={id:(Date.now()+1).toString(),text:n.answer,sender:"bot",timestamp:new Date,citations:n.citations};o(l=>[...l,i])}catch{const s={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};o(n=>[...n,s])}}catch{const s={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};o(n=>[...n,s])}finally{d(!1)}},O=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),I())},L=e=>e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return t.jsxs(t.Fragment,{children:[!u&&t.jsx("button",{onClick:()=>x(!0),className:"fixed bottom-6 right-6 z-50 w-16 h-16 text-white rounded-full shadow-lg hover:scale-105 transition-all flex items-center justify-center",style:{backgroundColor:"#4caf50"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#388e3c"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#4caf50"},children:t.jsx(J,{className:"w-7 h-7"})}),u&&t.jsxs("div",{className:"fixed bottom-6 right-6 z-50 w-full sm:w-96 max-w-[calc(100vw-3rem)] h-[600px] max-h-[calc(100vh-3rem)] flex flex-col bg-white rounded-xl shadow-2xl overflow-hidden",children:[t.jsxs("div",{className:"text-white p-4 flex items-center justify-between",style:{backgroundColor:"#1a2332"},children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{backgroundColor:"#4caf50"},children:t.jsx(v,{className:"w-5 h-5 text-white"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold",children:"Tax Assistant"}),t.jsx("p",{className:"text-xs opacity-90",children:y?"Onboarding...":"Online"})]})]}),t.jsx("button",{onClick:()=>x(!1),className:"p-1 text-white hover:bg-white/10 rounded transition",children:t.jsx(K,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-4",children:[m.length===0&&h&&t.jsx("div",{className:"flex justify-center p-4",children:t.jsx(M,{size:"md"})}),m.map(e=>t.jsxs("div",{className:`flex gap-2 ${e.sender==="user"?"justify-end":"justify-start"}`,children:[e.sender==="bot"&&t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#4caf50"},children:t.jsx(v,{className:"w-4 h-4 text-white"})}),t.jsxs("div",{className:"max-w-[75%] flex flex-col gap-1",children:[t.jsxs("div",{className:`p-3 rounded-lg shadow-sm ${e.sender==="user"?"text-white":"bg-white text-gray-900"}`,style:e.sender==="user"?{backgroundColor:"#1a2332"}:{},children:[t.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-line",children:e.text}),e.sender==="bot"&&e.citations&&e.citations.length>0&&t.jsx("div",{className:"mt-3 pt-3 border-t border-gray-300",children:t.jsxs("div",{className:"flex items-start gap-2 text-xs",children:[t.jsx(U,{className:"w-3.5 h-3.5 mt-0.5 flex-shrink-0 text-blue-600"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-semibold text-gray-700 mb-1.5",children:"Legal Sources:"}),t.jsx("div",{className:"space-y-1",children:e.citations.map((a,r)=>t.jsxs("div",{className:"text-gray-600 leading-relaxed",children:[t.jsxs("span",{className:"font-medium",children:[r+1,"."]})," ",a.law_name,a.section_number&&t.jsxs("span",{className:"text-gray-500",children:[", Section ",a.section_number]}),a.year&&t.jsxs("span",{className:"text-gray-500",children:[" (",a.year,")"]})]},r))})]})]})})]}),e.sender==="bot"&&e.quickReplies&&e.quickReplies.length>0&&t.jsx("div",{className:"flex flex-col gap-2 mt-1",children:e.quickReplies.map(a=>t.jsx($,{variant:"outline",size:"sm",onClick:()=>T(a.payload,a.title),disabled:h,className:"text-left justify-start",children:a.title},a.payload))}),t.jsx("p",{className:`text-xs text-gray-500 px-1 ${e.sender==="user"?"text-right":"text-left"}`,children:L(e.timestamp)})]}),e.sender==="user"&&t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#2d3a4f"},children:t.jsx(P,{className:"w-4 h-4 text-white"})})]},e.id)),h&&m.length>0&&t.jsxs("div",{className:"flex justify-start gap-2",children:[t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center",style:{backgroundColor:"#4caf50"},children:t.jsx(v,{className:"w-4 h-4 text-white"})}),t.jsx("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:t.jsx(M,{size:"sm"})})]}),t.jsx("div",{ref:D})]}),t.jsx("div",{className:"border-t border-gray-200"}),t.jsxs("div",{className:"p-4 bg-white flex gap-2 items-end",children:[t.jsx("textarea",{placeholder:"Type your message...",value:g,onChange:e=>N(e.target.value),onKeyPress:O,disabled:h,rows:1,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none bg-gray-50 disabled:opacity-50",style:{maxHeight:"100px",minHeight:"40px"}}),t.jsx("button",{onClick:I,disabled:!g.trim()||h,className:"w-10 h-10 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#4caf50"},onMouseEnter:e=>{e.currentTarget.disabled||(e.currentTarget.style.backgroundColor="#388e3c")},onMouseLeave:e=>{e.currentTarget.disabled||(e.currentTarget.style.backgroundColor="#4caf50")},children:t.jsx(z,{className:"w-5 h-5"})})]})]})]})}export{ee as default};
