import{r as c,j as t,S as A}from"./index-ozb2rjOE.js";import{o as M,U as $,S as J}from"./onboardingAPI-DcLx46n3.js";import{b as K}from"./api-sa1Artjr.js";import{B as U}from"./Button-Cd51FRts.js";import{c as F}from"./createLucideIcon-D-ZStHbC.js";import{B as N}from"./bot-BX-0lCIx.js";import{X as G}from"./x-BusEZ7ZQ.js";import{F as Q}from"./file-text-nvJf3LQ8.js";/**
 * @license lucide-react v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]],H=F("message-circle",V),j={ask:async(d,u)=>(await K.post("/api/rag/ask",{question:d,user_context:u})).data},E=[{key:"thinking",label:"Thinking"},{key:"searching",label:"Searching"},{key:"generating",label:"Generating"}],W=({currentStep:d})=>{const u=E.find(m=>m.key===d)||E[0];return t.jsx("div",{className:"flex items-center gap-2",children:t.jsxs("span",{className:"text-sm text-gray-500 italic animate-pulse transition-opacity duration-300",children:[u.label,t.jsxs("span",{className:"inline-flex ml-1",children:[t.jsx("span",{className:"animate-bounce",style:{animationDelay:"0ms"},children:"."}),t.jsx("span",{className:"animate-bounce",style:{animationDelay:"150ms"},children:"."}),t.jsx("span",{className:"animate-bounce",style:{animationDelay:"300ms"},children:"."})]})]},u.key)})};function re(){const[d,u]=c.useState(!1),[m,i]=c.useState([]),[h,v]=c.useState(""),[p,T]=c.useState(null),[L,k]=c.useState(null),[g,x]=c.useState(!1),[O,f]=c.useState("thinking"),[S,y]=c.useState(!1),D=c.useRef(null),P=()=>{var e;(e=D.current)==null||e.scrollIntoView({behavior:"smooth"})};c.useEffect(()=>{P()},[m]);const R=()=>{let e=localStorage.getItem("kamafile_user_id");return e||(e=`web_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem("kamafile_user_id",e)),e};c.useEffect(()=>{d&&!p&&m.length===0&&C()},[d]);const w=async()=>{f("thinking"),await new Promise(e=>setTimeout(e,1200)),f("searching"),await new Promise(e=>setTimeout(e,1800)),f("generating")};c.useEffect(()=>{g||f("thinking")},[g]),c.useEffect(()=>{const e=()=>{u(!0)};return window.addEventListener("openChatWidget",e),()=>{window.removeEventListener("openChatWidget",e)}},[]);const C=async()=>{x(!0),y(!0);try{const e=R(),n=await M.startOnboarding({channel:"web",user_identifier:e});T(n.session_id),k(n.step||null);const r={id:Date.now().toString(),text:n.message,sender:"bot",timestamp:new Date,quickReplies:n.quick_replies||void 0};i([r])}catch{const n={id:Date.now().toString(),text:"Sorry, I'm having trouble starting. Please try again.",sender:"bot",timestamp:new Date};i([n])}finally{x(!1)}},q=async(e,n)=>{if(!p)return;const r={id:Date.now().toString(),text:n,sender:"user",timestamp:new Date};if(i(s=>[...s,r]),x(!0),I(n)){y(!1);try{const s=localStorage.getItem("user");let a;if(s)try{a={user_type:JSON.parse(s).user_type}}catch{}w();const o=await j.ask(n,a),l={id:(Date.now()+1).toString(),text:o.answer,sender:"bot",timestamp:new Date,citations:o.citations,intent:o.intent,confidence:o.confidence};i(b=>[...b,l])}catch{const a={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};i(o=>[...o,a])}finally{x(!1)}return}try{const s=await M.processStep({session_id:p,step:L||"",response:e});k(s.step||null);const a=!s.completed&&s.status==="onboarding";if(y(a),!a){const l={id:(Date.now()+1).toString(),text:s.message||"Great! I'm ready to help with your tax questions. Ask me anything!",sender:"bot",timestamp:new Date};i(b=>[...b,l]);return}const o={id:(Date.now()+1).toString(),text:s.message,sender:"bot",timestamp:new Date,quickReplies:s.quick_replies||void 0};i(l=>[...l,o])}catch{const a={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};i(o=>[...o,a])}finally{x(!1)}},I=e=>{const n=["tax","vat","paye","wht","cgt","cit","petroleum","stamp","duty","customs","firs","federal inland revenue","inland revenue","section","act","law","regulation","compliance","filing","return","assessment","penalty","fine","taxable","exempt","deduction","allowance","relief","taxable income","tax rate"],r=e.toLowerCase();return n.some(s=>r.includes(s))},_=async()=>{if(!h.trim())return;if(!p){await C();return}const e={id:Date.now().toString(),text:h,sender:"user",timestamp:new Date};i(r=>[...r,e]);const n=h;v(""),x(!0);try{if(I(n))try{const r=localStorage.getItem("user");let s;if(r)try{s={user_type:JSON.parse(r).user_type}}catch{}w();const a=await j.ask(n,s),o={id:(Date.now()+1).toString(),text:a.answer,sender:"bot",timestamp:new Date,citations:a.citations,intent:a.intent,confidence:a.confidence};i(l=>[...l,o]),S&&y(!1)}catch{const s={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};i(a=>[...a,s])}else if(S)try{const r=localStorage.getItem("user");let s;if(r)try{s={user_type:JSON.parse(r).user_type}}catch{}w();const a=await j.ask(n,s),o={id:(Date.now()+1).toString(),text:a.answer,sender:"bot",timestamp:new Date,citations:a.citations,intent:a.intent,confidence:a.confidence};i(l=>[...l,o])}catch{const s={id:(Date.now()+1).toString(),text:"I'm having trouble processing your message. Please try again.",sender:"bot",timestamp:new Date};i(a=>[...a,s])}else try{const r=localStorage.getItem("user");let s;if(r)try{s={user_type:JSON.parse(r).user_type}}catch{}w();const a=await j.ask(n,s),o={id:(Date.now()+1).toString(),text:a.answer,sender:"bot",timestamp:new Date,citations:a.citations,intent:a.intent,confidence:a.confidence};i(l=>[...l,o])}catch{const s={id:(Date.now()+1).toString(),text:"I'm having trouble accessing the tax knowledge base. Please try again or rephrase your question.",sender:"bot",timestamp:new Date};i(a=>[...a,s])}}catch{const s={id:(Date.now()+1).toString(),text:"Sorry, I'm having trouble processing that. Please try again.",sender:"bot",timestamp:new Date};i(a=>[...a,s])}finally{x(!1)}},B=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),_())},z=e=>e.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"});return t.jsxs(t.Fragment,{children:[!d&&t.jsx("button",{onClick:()=>u(!0),className:"fixed bottom-6 right-6 z-50 w-16 h-16 text-white rounded-full shadow-lg hover:scale-105 transition-all flex items-center justify-center",style:{backgroundColor:"#4caf50"},onMouseEnter:e=>{e.currentTarget.style.backgroundColor="#388e3c"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="#4caf50"},children:t.jsx(H,{className:"w-7 h-7"})}),d&&t.jsxs("div",{className:"fixed bottom-6 right-6 z-50 w-full sm:w-96 max-w-[calc(100vw-3rem)] h-[600px] max-h-[calc(100vh-3rem)] flex flex-col bg-white rounded-xl shadow-2xl overflow-hidden",children:[t.jsxs("div",{className:"text-white p-4 flex items-center justify-between",style:{backgroundColor:"#1a2332"},children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{backgroundColor:"#4caf50"},children:t.jsx(N,{className:"w-5 h-5 text-white"})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-semibold",children:"Tax Assistant"}),t.jsx("p",{className:"text-xs opacity-90",children:S?"Onboarding...":"Online"})]})]}),t.jsx("button",{onClick:()=>u(!1),className:"p-1 text-white hover:bg-white/10 rounded transition",children:t.jsx(G,{className:"w-5 h-5"})})]}),t.jsxs("div",{className:"flex-1 overflow-y-auto p-4 bg-gray-50 flex flex-col gap-4",children:[m.length===0&&g&&t.jsx("div",{className:"flex justify-center p-4",children:t.jsx(A,{size:"md"})}),m.map(e=>t.jsxs("div",{className:`flex gap-2 ${e.sender==="user"?"justify-end":"justify-start"}`,children:[e.sender==="bot"&&t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#4caf50"},children:t.jsx(N,{className:"w-4 h-4 text-white"})}),t.jsxs("div",{className:"max-w-[75%] flex flex-col gap-1",children:[t.jsxs("div",{className:`p-3 rounded-lg shadow-sm ${e.sender==="user"?"text-white":"bg-white text-gray-900"}`,style:e.sender==="user"?{backgroundColor:"#1a2332"}:{},children:[t.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-line",children:e.text}),e.sender==="bot"&&e.citations&&e.citations.length>0&&t.jsx("div",{className:"mt-3 pt-3 border-t border-gray-300",children:t.jsxs("div",{className:"flex items-start gap-2 text-xs",children:[t.jsx(Q,{className:"w-3.5 h-3.5 mt-0.5 flex-shrink-0 text-blue-600"}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"font-semibold text-gray-700 mb-1.5",children:"Legal Sources:"}),t.jsx("div",{className:"space-y-1",children:e.citations.map((n,r)=>t.jsxs("div",{className:"text-gray-600 leading-relaxed",children:[t.jsxs("span",{className:"font-medium",children:[r+1,"."]})," ",n.law_name,n.section_number&&t.jsxs("span",{className:"text-gray-500",children:[", Section ",n.section_number]}),n.year&&t.jsxs("span",{className:"text-gray-500",children:[" ","(",n.year,")"]})]},r))})]})]})})]}),e.sender==="bot"&&e.quickReplies&&e.quickReplies.length>0&&t.jsx("div",{className:"flex flex-col gap-2 mt-1",children:e.quickReplies.map(n=>t.jsx(U,{variant:"outline",size:"sm",onClick:()=>q(n.payload,n.title),disabled:g,className:"text-left justify-start",children:n.title},n.payload))}),t.jsx("p",{className:`text-xs text-gray-500 px-1 ${e.sender==="user"?"text-right":"text-left"}`,children:z(e.timestamp)})]}),e.sender==="user"&&t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#2d3a4f"},children:t.jsx($,{className:"w-4 h-4 text-white"})})]},e.id)),g&&m.length>0&&t.jsxs("div",{className:"flex justify-start gap-2",children:[t.jsx("div",{className:"w-8 h-8 rounded-full flex items-center justify-center",style:{backgroundColor:"#4caf50"},children:t.jsx(N,{className:"w-4 h-4 text-white"})}),t.jsx("div",{className:"bg-white p-3 rounded-lg shadow-sm min-w-[200px]",children:t.jsx(W,{currentStep:O})})]}),t.jsx("div",{ref:D})]}),t.jsx("div",{className:"border-t border-gray-200"}),t.jsxs("div",{className:"p-4 bg-white flex gap-2 items-end",children:[t.jsx("textarea",{placeholder:"Type your message...",value:h,onChange:e=>v(e.target.value),onKeyPress:B,disabled:g,rows:1,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none bg-gray-50 disabled:opacity-50",style:{maxHeight:"100px",minHeight:"40px"}}),t.jsx("button",{onClick:_,disabled:!h.trim()||g,className:"w-10 h-10 text-white rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center flex-shrink-0",style:{backgroundColor:"#4caf50"},onMouseEnter:e=>{e.currentTarget.disabled||(e.currentTarget.style.backgroundColor="#388e3c")},onMouseLeave:e=>{e.currentTarget.disabled||(e.currentTarget.style.backgroundColor="#4caf50")},children:t.jsx(J,{className:"w-5 h-5"})})]})]})]})}export{re as default};
